#!/bin/bash
# Step 2: í…ŒìŠ¤íŠ¸ ì„¤ê³„ (Kent Beck TDD ì›ì¹™ ì ìš©)

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/../lib/common.sh"

run_step2() {
    local spec_file=$1
    local mode=$2
    local timestamp=$3
    
    log_step "2ë‹¨ê³„: í…ŒìŠ¤íŠ¸ ì„¤ê³„ (Kent Beck ë°©ì‹)"
    
    local prompt_file="agents/logs/step2_test_design.prompt"
    local result_file="agents/results/step2_design_$timestamp.md"
    
    cat > "$prompt_file" << PROMPT

# SYSTEM: ë‹¹ì‹ ì€ í…ŒìŠ¤íŠ¸ ì„¤ê³„ ì „ë¬¸ê°€ì´ìž Kent Beckì˜ TDD ì² í•™ì„ ì‹¤ì²œí•˜ëŠ” ì†Œí”„íŠ¸ì›¨ì–´ ìž¥ì¸ìž…ë‹ˆë‹¤.

ê²€ì¦ëœ ëª…ì„¸ë¥¼ ë°”íƒ•ìœ¼ë¡œ, Kent Beckì˜ í…ŒìŠ¤íŠ¸ ìž‘ì„± ì›ì¹™ì— ë”°ë¼ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ë¥¼ ì„¤ê³„í•´ì£¼ì„¸ìš”:

$(cat "$spec_file")

---

## ðŸŽ¯ Kent Beckì˜ í…ŒìŠ¤íŠ¸ ìž‘ì„± ì›ì¹™ (ìš”ì•½ ë¬¸ì„œ)

1. **ìž‘ê²Œ ì‹œìž‘í•˜ë¼ (Start Small)**  
   - ê°€ìž¥ ë‹¨ìˆœí•œ ë™ìž‘ë¶€í„° ê²€ì¦í•œë‹¤.  
   - ì½”ë“œë¥¼ ìž‘ì„±í•˜ê¸° ì „ì— ì‹¤íŒ¨í•˜ëŠ” í…ŒìŠ¤íŠ¸ë¥¼ ë§Œë“ ë‹¤.

2. **ë‹¨ê³„ì ìœ¼ë¡œ í™•ìž¥í•˜ë¼ (Grow Step by Step)**  
   - ì‹¤íŒ¨í•˜ëŠ” í…ŒìŠ¤íŠ¸ë¥¼ í†µê³¼í•  ë§Œí¼ë§Œ êµ¬í˜„í•œë‹¤.  
   - ë¦¬íŒ©í† ë§ ì „ì— í•­ìƒ í…ŒìŠ¤íŠ¸ê°€ ì´ˆë¡ìƒ‰ ìƒíƒœì¸ì§€ í™•ì¸í•œë‹¤.

3. **ëª…í™•í•˜ê²Œ ì´ë¦„ ì§“ê¸° (Name Clearly)**  
   - í…ŒìŠ¤íŠ¸ ì´ë¦„ì€ ë™ìž‘ì˜ ì˜ë„ë¥¼ í‘œí˜„í•´ì•¼ í•œë‹¤.  
   - â€œshould [ê¸°ëŒ€ ë™ìž‘] when [ì¡°ê±´]â€ íŒ¨í„´ì„ ë”°ë¥¸ë‹¤.

4. **ì¤‘ë³µì„ ì œê±°í•˜ë¼ (Eliminate Duplication)**  
   - í…ŒìŠ¤íŠ¸ì™€ ì½”ë“œì—ì„œ ì¤‘ë³µì„ ì§€ì†ì ìœ¼ë¡œ ì œê±°í•œë‹¤.  
   - ëª…í™•ì„±ê³¼ ê°„ê²°í•¨ì„ ë™ì‹œì— ì¶”êµ¬í•œë‹¤.

5. **í•˜ë‚˜ì˜ ì´ìœ ë§Œìœ¼ë¡œ ì‹¤íŒ¨í•´ì•¼ í•œë‹¤ (Single Responsibility)**  
   - ê° í…ŒìŠ¤íŠ¸ëŠ” í•œ ê°€ì§€ ì‹¤íŒ¨ ì›ì¸ë§Œ ê°€ì ¸ì•¼ í•œë‹¤.  
   - ë³µí•© ë™ìž‘ì€ ë³„ë„ í…ŒìŠ¤íŠ¸ë¡œ ë¶„ë¦¬í•œë‹¤.

6. **ì˜ˆì¸¡ ê°€ëŠ¥í•œ í…ŒìŠ¤íŠ¸ (Predictable Tests)**  
   - ì™¸ë¶€ ì˜ì¡´ì„±ì€ Mock/Stubbingìœ¼ë¡œ ê²©ë¦¬í•œë‹¤.  
   - í…ŒìŠ¤íŠ¸ëŠ” ìˆœì„œì— ì˜ì¡´í•˜ì§€ ì•ŠëŠ”ë‹¤.

7. **ì½ê¸° ì‰¬ìš´ í…ŒìŠ¤íŠ¸ (Readable Tests)**  
   - AAA(Arrange-Act-Assert) ë˜ëŠ” Given-When-Then êµ¬ì¡°ë¥¼ ë”°ë¥¸ë‹¤.  
   - ì½”ë“œë³´ë‹¤ â€œí–‰ë™ ì‹œë‚˜ë¦¬ì˜¤â€ë¡œ ì½ížˆê²Œ ìž‘ì„±í•œë‹¤.

---

## ðŸ§© í…ŒìŠ¤íŠ¸ ì„¤ê³„ ì§€ì¹¨

ë‹¤ìŒ ì›ì¹™ì„ ë°˜ë“œì‹œ ë”°ë¥´ì„¸ìš”:
- AAA íŒ¨í„´ (Arrange â†’ Act â†’ Assert)
- í…ŒìŠ¤íŠ¸ ë…ë¦½ì„± ë³´ìž¥
- ëª…í™•í•œ ì˜ë„ í‘œí˜„
- ê²½ê³„ê°’ ë° ì˜ˆì™¸ ì¼€ì´ìŠ¤ í¬í•¨

í…ŒìŠ¤íŠ¸ ë¶„ë¥˜:
- Unit Tests: ê°œë³„ í•¨ìˆ˜ ë˜ëŠ” ë¡œì§ ë‹¨ìœ„ ê²€ì¦
- Integration Tests: ëª¨ë“ˆ ê°„ ìƒí˜¸ìž‘ìš© ê²€ì¦
- Edge Cases: ê²½ê³„ ì¡°ê±´, ì˜ˆì™¸ ìƒí™© ê²€ì¦

ê° í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ëŠ” ë‹¤ìŒ í˜•ì‹ì„ ë”°ë¦…ë‹ˆë‹¤:
- **ì´ë¦„**: should [expected behavior] when [condition]
- **Given**: ì‚¬ì „ ì¡°ê±´
- **When**: ì‹¤í–‰ ì¡°ê±´
- **Then**: ê¸°ëŒ€ ê²°ê³¼
- **ìš°ì„ ìˆœìœ„**: high / medium / low

---

## ðŸ§  í’ˆì§ˆ ê¸°ì¤€
- ê° í…ŒìŠ¤íŠ¸ëŠ” ë‹¨ì¼ ë™ìž‘ë§Œ ê²€ì¦í•´ì•¼ í•¨ (Single Assertion Principle)
- Mocking/Stubbingì˜ í•„ìš”ì„±ì„ ëª…ì‹œ
- ìƒíƒœ ë³€í™”ê°€ ìžˆë‹¤ë©´ Before/After ëª…ì‹œ
- ì™¸ë¶€ ë°ì´í„° ì˜ì¡´ì„± ì œê±° (API, localStorage, DB ë“±)
- í…ŒìŠ¤íŠ¸ëŠ” ëª…ì„¸ì˜ ì˜ë„ë¥¼ ë“œëŸ¬ë‚´ì•¼ í•˜ë©°, êµ¬í˜„ ì„¸ë¶€ì‚¬í•­ì— ì˜ì¡´í•˜ì§€ ì•Šì•„ì•¼ í•¨

---

## ðŸ§ª í”„ë¡œì íŠ¸ ì»¨í…ìŠ¤íŠ¸
- í…ŒìŠ¤íŠ¸ í”„ë ˆìž„ì›Œí¬: **Vitest**
- í…ŒìŠ¤íŠ¸ íŒŒì¼ ìœ„ì¹˜: `src/__tests__/`
- React ì»´í¬ë„ŒíŠ¸ í…ŒìŠ¤íŠ¸: **@testing-library/react**

---

## ðŸ§¾ ì¶œë ¥ í˜•ì‹ ì˜ˆì‹œ

### í…ŒìŠ¤íŠ¸ ìŠ¤ìœ„íŠ¸: [ê¸°ëŠ¥ëª…]

#### í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ 1
- **ì´ë¦„**: should ...
- **íƒ€ìž…**: unit/integration/edge
- **ìš°ì„ ìˆœìœ„**: high/medium/low
- **Given**: ...
- **When**: ...
- **Then**: ...

[ë‚˜ë¨¸ì§€ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ë“¤...]

PROMPT
    
    if [ "$mode" == "--auto" ]; then
        run_claude "$prompt_file" "$result_file" "í…ŒìŠ¤íŠ¸ ì„¤ê³„ (Kent Beck ì›ì¹™)"
    elif [ "$mode" == "--interactive" ]; then
        read -p "Claude CLIë¡œ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/n): " confirm
        if [ "$confirm" == "y" ]; then
            run_claude "$prompt_file" "$result_file" "í…ŒìŠ¤íŠ¸ ì„¤ê³„ (Kent Beck ì›ì¹™)"
        fi
    else
        log "í”„ë¡¬í”„íŠ¸ ìƒì„±: $prompt_file"
    fi
    
    log_success "2ë‹¨ê³„ ì™„ë£Œ (Kent Beck ìŠ¤íƒ€ì¼ í…ŒìŠ¤íŠ¸ ì„¤ê³„)"
}