#!/bin/bash
# Git ê´€ë ¨ í•¨ìˆ˜

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/common.sh"

# ê¸°ëŠ¥ ë¸Œëœì¹˜ ìƒì„±
create_feature_branch() {
    local feature_name=$1
    
    if [ "$AUTO_BRANCH" != "true" ]; then
        return 0
    fi
    
    log_step "ê¸°ëŠ¥ ë¸Œëœì¹˜ ìƒì„±"
    
    if ! git rev-parse --git-dir > /dev/null 2>&1; then
        log_error "Git ì €ì¥ì†Œê°€ ì•„ë‹™ë‹ˆë‹¤."
        return 1
    fi
    
    local current_branch=$(git branch --show-current)
    
    if [ "$current_branch" != "main" ] && [ "$current_branch" != "master" ]; then
        log_warning "ì´ë¯¸ ê¸°ëŠ¥ ë¸Œëœì¹˜ì— ìˆìŠµë‹ˆë‹¤: $current_branch"
        read -p "í˜„ì¬ ë¸Œëœì¹˜ë¥¼ ì‚¬ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/n): " use_current
        if [ "$use_current" == "y" ]; then
            FEATURE_BRANCH="$current_branch"
            log_success "í˜„ì¬ ë¸Œëœì¹˜ ì‚¬ìš©: $FEATURE_BRANCH"
            return 0
        fi
    fi
    
    local timestamp=$(date +%Y%m%d-%H%M%S)
    FEATURE_BRANCH="feature/tdd-${feature_name}-${timestamp}"
    
    log "ë¸Œëœì¹˜ ìƒì„±: $FEATURE_BRANCH"
    
    if [ -n "$(git status --porcelain)" ]; then
        log_warning "ì»¤ë°‹ë˜ì§€ ì•Šì€ ë³€ê²½ì‚¬í•­ì´ ìˆìŠµë‹ˆë‹¤."
        read -p "ë³€ê²½ì‚¬í•­ì„ stash í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/n): " do_stash
        if [ "$do_stash" == "y" ]; then
            git stash save "Auto-stash before creating TDD branch"
            log_success "ë³€ê²½ì‚¬í•­ stash ì™„ë£Œ"
        else
            log_error "ë¸Œëœì¹˜ ìƒì„±ì„ ì·¨ì†Œí•©ë‹ˆë‹¤."
            return 1
        fi
    fi
    
    local main_branch="main"
    if ! git rev-parse --verify main > /dev/null 2>&1; then
        main_branch="master"
    fi
    
    log "ìµœì‹  $main_branch ë¸Œëœì¹˜ ê°€ì ¸ì˜¤ëŠ” ì¤‘..."
    git fetch origin "$main_branch" 2>/dev/null || true
    git checkout "$main_branch" 2>/dev/null || true
    git pull origin "$main_branch" 2>/dev/null || true
    
    git checkout -b "$FEATURE_BRANCH"
    
    log_success "ë¸Œëœì¹˜ ìƒì„± ì™„ë£Œ: $FEATURE_BRANCH"
    echo ""
}

# ìë™ ì»¤ë°‹
auto_commit() {
    local stage=$1
    local files=$2
    local feature_name=$3
    
    if [ "$AUTO_COMMIT" != "true" ]; then
        return 0
    fi
    
    log "Git ì»¤ë°‹ ìƒì„± ì¤‘..."
    
    if ! git rev-parse --git-dir > /dev/null 2>&1; then
        log_warning "Git ì €ì¥ì†Œê°€ ì•„ë‹™ë‹ˆë‹¤. ì»¤ë°‹ì„ ê±´ë„ˆëœë‹ˆë‹¤."
        return 1
    fi
    
    if [ -z "$(git status --porcelain)" ]; then
        log_warning "ì»¤ë°‹í•  ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
        return 1
    fi
    
    if [ -n "$files" ]; then
        git add $files
    else
        git add .
    fi
    
    local commit_message
    case $stage in
        RED)
            commit_message="test: add failing tests for $feature_name (RED)

ğŸ“ RED ë‹¨ê³„ - ì‹¤íŒ¨í•˜ëŠ” í…ŒìŠ¤íŠ¸ ì‘ì„±
- AAA íŒ¨í„´ ì ìš©
- ì—£ì§€ ì¼€ì´ìŠ¤ í¬í•¨

Generated by TDD Orchestrator"
            ;;
        GREEN)
            commit_message="feat: implement $feature_name (GREEN)

âœ… GREEN ë‹¨ê³„ - í…ŒìŠ¤íŠ¸ í†µê³¼í•˜ëŠ” êµ¬í˜„
- ìµœì†Œí•œì˜ êµ¬í˜„
- ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼

Generated by TDD Orchestrator"
            ;;
        REFACTOR)
            commit_message="refactor: improve $feature_name (REFACTOR)

â™»ï¸ REFACTOR ë‹¨ê³„ - ì½”ë“œ í’ˆì§ˆ ê°œì„ 
- DRY ì›ì¹™ ì ìš©
- ëª…ëª… ê°œì„ 
- ë³µì¡ë„ ê°ì†Œ

Generated by TDD Orchestrator"
            ;;
    esac
    
    git commit -m "$commit_message"
    
    if [ $? -eq 0 ]; then
        log_success "ì»¤ë°‹ ìƒì„± ì™„ë£Œ"
        local commit_hash=$(git rev-parse --short HEAD)
        echo -e "${CYAN}  Commit: $commit_hash${NC}"
        return 0
    else
        log_error "ì»¤ë°‹ ì‹¤íŒ¨"
        return 1
    fi
}

# PR ê°€ì´ë“œ ì¶œë ¥
show_pr_guide() {
    log_step "PR ìƒì„± ê°€ì´ë“œ ğŸš€"
    
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${CYAN}ë‹¤ìŒ ë‹¨ê³„ë¡œ PRì„ ìƒì„±í•˜ì„¸ìš”:${NC}"
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo "1ï¸âƒ£  ë¦¬ëª¨íŠ¸ë¡œ í‘¸ì‹œ:"
    echo -e "   ${GREEN}git push -u origin $FEATURE_BRANCH${NC}"
    echo ""
    echo "2ï¸âƒ£  GitHubì—ì„œ PR ìƒì„±:"
    echo "   ë¸Œë¼ìš°ì €ì—ì„œ ìë™ìœ¼ë¡œ 'Create Pull Request' ë²„íŠ¼ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤."
    echo ""
    echo "3ï¸âƒ£  PR í…œí”Œë¦¿ ì²´í¬ë¦¬ìŠ¤íŠ¸ ì‘ì„±:"
    echo "   ${YELLOW}ê¸°ë³¸ ê³¼ì œ(Hard)${NC}"
    echo "   - [x] Agent êµ¬í˜„ ëª…ì„¸ ë¬¸ì„œ ë˜ëŠ” ì½”ë“œ"
    echo "   - [x] ì»¤ë°‹ë³„ ì˜¬ë°”ë¥´ê²Œ ë‹¨ê³„ì— ëŒ€í•œ ì‘ì—…"
    echo "   - [x] ê²°ê³¼ë¥¼ ì˜¬ë°”ë¡œ ì–»ê¸°ìœ„í•œ history ë˜ëŠ” log"
    echo "   - [x] AI ë„êµ¬ í™œìš©ì„ ê°œì„ í•˜ê¸° ìœ„í•´ ë…¸ë ¥í•œ ì "
    echo ""
    echo "4ï¸âƒ£  ì»¤ë°‹ íˆìŠ¤í† ë¦¬ í™•ì¸:"
    echo -e "   ${GREEN}git log --oneline --graph -n 10${NC}"
    echo ""
    
    if [ "$AUTO_COMMIT" == "true" ]; then
        echo -e "${MAGENTA}ğŸ“ ìƒì„±ëœ ì»¤ë°‹ íˆìŠ¤í† ë¦¬:${NC}"
        git log --oneline --graph --color=always -n 10 | sed 's/^/   /'
        echo ""
    fi
    
    if [ "$AUTO_PUSH" == "true" ]; then
        echo ""
        read -p "ë¦¬ëª¨íŠ¸ë¡œ í‘¸ì‹œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/n): " do_push
        if [ "$do_push" == "y" ]; then
            log "ìë™ í‘¸ì‹œ ì‹¤í–‰ ì¤‘..."
            git push -u origin "$FEATURE_BRANCH"
            
            if [ $? -eq 0 ]; then
                log_success "í‘¸ì‹œ ì™„ë£Œ!"
                echo ""
                echo -e "${GREEN}âœ¨ GitHubì—ì„œ PRì„ ìƒì„±í•˜ì„¸ìš”!${NC}"
                echo ""
                local repo_url=$(git remote get-url origin | sed 's/\.git$//' | sed 's/git@github.com:/https:\/\/github.com\//')
                echo "   $repo_url/compare/$FEATURE_BRANCH"
            else
                log_error "í‘¸ì‹œ ì‹¤íŒ¨"
            fi
        fi
    fi
    
    echo ""
    echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
}
